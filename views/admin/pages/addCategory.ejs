<%- include("../includes/navbar.ejs") %>
<%- include("../includes/flash.ejs") %>

<ol class="breadcrumb p-3 rounded" style="background-color: rgb(226, 222, 222);">
    <li class="breadcrumb-item">
        <a href="/admin">Dashboard</a>
    </li>
    <li class="breadcrumb-item active">Add Category</li>
</ol>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Add Category</h5>
    </div>
    <div class="card-body">
        <!-- Connection Status Alert -->
        <div id="connectionStatus" class="alert alert-info" style="display: none;">
            <i class="fas fa-info-circle"></i> Checking connection...
        </div>

        <!-- Add Category Form -->
        <form action="/admin/addCategory" method="post" enctype="multipart/form-data" id="addCategoryForm">
            <div class="row">
                <div class="form-group col-md-8 mb-3">
                    <label for="category_name" class="form-label">Category Name <span class="text-danger">*</span></label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="category_name" 
                        name="category_name" 
                        placeholder="Enter category name"
                        required
                        minlength="2"
                        maxlength="50"
                        autocomplete="off"
                    >
                    <div class="invalid-feedback">
                        Please provide a valid category name (2-50 characters).
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="form-group col-md-8 mb-3">
                    <label for="category_image" class="form-label">Category Image <span class="text-danger">*</span></label>
                    <input 
                        type="file" 
                        class="form-control" 
                        name="category_image" 
                        id="category_image"
                        accept="image/jpeg,image/jpg,image/png,image/gif"
                        required
                    >
                    <div class="form-text">
                        Supported formats: JPG, PNG, GIF. Maximum size: 5MB.
                    </div>
                    <div class="invalid-feedback">
                        Please select a valid image file.
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mt-2" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="progressBar">0%</div>
                        </div>
                        <small class="text-muted">Uploading... Please don't close this page.</small>
                    </div>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" class="mt-3" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        <div class="mt-1">
                            <small class="text-muted">File size: <span id="fileSize"></span></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <button type="submit" class="btn btn-success me-2" id="submitBtn">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                    <a href="/admin/manageCategory" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Categories
                    </a>
                </div>
            </div>
        </form>
        <!-- End Form -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addCategoryForm');
    const categoryNameInput = document.getElementById('category_name');
    const categoryImageInput = document.getElementById('category_image');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const submitBtn = document.getElementById('submitBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const connectionStatus = document.getElementById('connectionStatus');
    const fileSize = document.getElementById('fileSize');

    // Check connection status
    function checkConnection() {
        if (!navigator.onLine) {
            connectionStatus.className = 'alert alert-warning';
            connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No internet connection. Please check your connection before uploading.';
            connectionStatus.style.display = 'block';
            submitBtn.disabled = true;
            return false;
        } else {
            connectionStatus.style.display = 'none';
            submitBtn.disabled = false;
            return true;
        }
    }

    // Check connection on page load and when online status changes
    checkConnection();
    window.addEventListener('online', checkConnection);
    window.addEventListener('offline', checkConnection);

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Enhanced form validation
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Always prevent default first
        
        if (!checkConnection()) {
            alert('Please check your internet connection before submitting.');
            return false;
        }

        let isValid = true;
        
        // Validate category name
        const categoryName = categoryNameInput.value.trim();
        if (categoryName.length < 2) {
            categoryNameInput.classList.add('is-invalid');
            isValid = false;
        } else {
            categoryNameInput.classList.remove('is-invalid');
            categoryNameInput.classList.add('is-valid');
        }
        
        // Validate image file
        if (!categoryImageInput.files || categoryImageInput.files.length === 0) {
            categoryImageInput.classList.add('is-invalid');
            isValid = false;
        } else {
            const file = categoryImageInput.files[0];
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            if (!validTypes.includes(file.type)) {
                categoryImageInput.classList.add('is-invalid');
                alert('Please select a valid image file (JPG, PNG, or GIF)');
                isValid = false;
            } else if (file.size > maxSize) {
                categoryImageInput.classList.add('is-invalid');
                alert('File size must be less than 5MB');
                isValid = false;
            } else {
                categoryImageInput.classList.remove('is-invalid');
                categoryImageInput.classList.add('is-valid');
            }
        }
        
        if (!isValid) {
            return false;
        }
        
        // Show loading state and progress
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        uploadProgress.style.display = 'block';
        
        // Simulate progress for better UX (since we can't get real progress easily)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) {
                clearInterval(progressInterval);
                progress = 90;
            }
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
        }, 200);

        // Create FormData with proper error handling
        try {
            const formData = new FormData();
            formData.append('category_name', categoryName);
            formData.append('category_image', categoryImageInput.files[0]);

            // Submit form using fetch with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout

            fetch('/admin/addCategory', {
                method: 'POST',
                body: formData,
                signal: controller.signal,
                // Don't set Content-Type header, let browser set it with boundary
            })
            .then(response => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                if (response.redirected) {
                    // Success - redirect
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    progressBar.className = 'progress-bar bg-success';
                    setTimeout(() => {
                        window.location.href = response.url;
                    }, 500);
                } else if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                } else {
                    // Handle other responses
                    window.location.href = '/admin/manageCategory';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                console.error('Upload error:', error);
                
                // Reset form state
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Category';
                uploadProgress.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
                
                if (error.name === 'AbortError') {
                    alert('Upload timeout. Please check your connection and try again.');
                } else {
                    alert('Upload failed: ' + error.message + '. Please try again.');
                }
            });
            
        } catch (error) {
            console.error('Form submission error:', error);
            alert('Failed to prepare upload. Please try again.');
            
            // Reset form state
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Category';
            uploadProgress.style.display = 'none';
        }
    });

    // Image preview and validation
    categoryImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            if (!validTypes.includes(file.type)) {
                alert('Please select a valid image file (JPG, PNG, or GIF)');
                this.value = '';
                imagePreview.style.display = 'none';
                return;
            }
            
            if (file.size > maxSize) {
                alert('File size must be less than 5MB');
                this.value = '';
                imagePreview.style.display = 'none';
                return;
            }
            
            // Show file size
            fileSize.textContent = formatFileSize(file.size);
            
            // Show image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // Remove any previous validation classes
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            imagePreview.style.display = 'none';
        }
    });

    // Real-time validation for category name
    categoryNameInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length >= 2) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else if (value.length > 0) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        } else {
            this.classList.remove('is-invalid', 'is-valid');
        }
    });

    // Prevent accidental form submission on Enter key
    categoryNameInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
        }
    });
});
</script>

<%- include("../includes/footer.ejs") %>